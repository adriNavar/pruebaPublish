@model GeoSit.Client.Web.Models.ValuacionModel
@using GeoSit.Client.Web.Controllers;
@using GeoSit.Data.BusinessEntities.Valuaciones;
@{
    ViewBag.Title = "Edición de Valuación";
    ViewBag.Description = "";
    ViewBag.MensajeEntrada = "";

}
<link href="~/Content/jquery.jscrollpane.css" rel="stylesheet" />
<link href="~/Content/dataTables.bootstrap.css" rel="stylesheet" />
<link href="~/Content/formValidation.min.css" rel="stylesheet" />
<link href="~/Scripts/jstree/dist/themes/default/style.css" rel="stylesheet" />
<link href="~/Content/valuacion.css" rel="stylesheet" />
<link href="~/Content/bootstrap-datetimepicker.css" rel="stylesheet" />

<style type="text/css">
    #Grilla_VP tbody tr:hover {
        background-color: lightblue !important;
    }
</style>


<div class="modal fade" id="myModal" tabindex="-100" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    @using (Ajax.BeginForm("GrabaValuacionParcela", "Valuacion", new { ReturnUrl = ViewBag.ReturnUrl }, new AjaxOptions { }, new { id = "form", role = "form", novalidate = "", autocomplete = "off" }))
    {  @Html.AntiForgeryToken()
        ViewBag.MensajeEntrada = Model.Mensaje;
        @Html.HiddenFor(model => model.EdicionParcela.UnidadTributariaID)
        @Html.HiddenFor(model => model.EdicionParcela.Tipo_Parcela)
        @Html.HiddenFor(model => model.EdicionParcela.Id_Parcela)
        @Html.HiddenFor(model => model.EdicionParcela.Id_Zona_Atributo)
        @Html.HiddenFor(model => model.EdicionParcela.C1T)
        @Html.HiddenFor(model => model.EdicionParcela.C2T)
        @Html.HiddenFor(model => model.EdicionParcela.C3T)
        @Html.HiddenFor(model => model.EdicionParcela.C4T)
        @Html.HiddenFor(model => model.EdicionParcela.IdPadron)

        <div class="modal-dialog " style="width: 90%; ">
            <div class="modal-content">
                <div class="modal-header centrado" style="padding: 20px 0 40px;">
                    <h4 class="modal-title col-lg-12 col-xs-12 col-sm-12 col-md-12" id="myModalLabel" style="color:#000000">@ViewBag.Title</h4>
                </div>
                <div class="modal-body modal-body-scroll">


                    @*Grillas*@
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <table width="100%" border="0">
                                <tr>
                                    <td width="30%" align="left">
                                        Valuación de Parcelas - Edición
                                    </td>
                                    <td width="70%" align="right">
                                        Parcela: @Model.EdicionParcela.Nomenclatura - @Model.EdicionParcela.Tipo_Parcela
                                    </td>
                                </tr>

                            </table>

                        </div>

                        <div id="accordion0">
                            <div class="panel-group panel-primary">
                                <div class="panel-heading" id="PanelValuacion0" style="height:40px;">
                                    <div class="col-lg-11 col-xs-11 col-sm-11 col-md-11 sin-padding">
                                        Valuaciones
                                    </div>
                                    <div class="col-lg-1 col-xs-1 col-sm-1 col-md-1 text-right ">
                                        <span id="Flecha_Valuacion1" class="glyphicon glyphicon-triangle-top flecha-activada flecha" style="cursor:pointer;"></span>

                                    </div>
                                </div>
                                <div id="accordion_panel_1" class="panel-collapse collapse in" aria-expanded="true" style="border: solid; border-width: 1px; border-color: #a5a5a5; color: #000000">
                                    <div class="panel-body " style="color:black" id="Panel_Grillas_Tierra">

                                        <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12">
                                            <span class="text-danger">VP = VT + VM</span>
                                        </div>
                                        <div class="col-lg-8 col-xs-8 col-sm-8 col-md-8">
                                            <table id="Grilla_VP" class="table table-striped table-bordered table-responsive hover" cellspacing="0" style="width:100%">
                                                <thead>
                                                    <tr>
                                                        <th>id</th>
                                                        <th>Total</th>
                                                        <th>Tierra</th>
                                                        <th>Mejoras</th>
                                                        <th>Vig. Desde</th>
                                                        <th>Vig. Hasta</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    @{
                                                        var padrones = Model.EdicionParcela.listaPadrones;
                                                        for (int i = 0; i < padrones.Count; i++)
                                                        {
                                                            <tr>
                                                                <td>@padrones[i].IdPadronDetalle</td>
                                                                <td id="cValortotal">@(padrones[i].ValorTotal) </td>
                                                                <td>@padrones[i].ValorTierra @Html.Hidden("idPadron", padrones[i].IdPadron, new { @id = "idPadron" })</td>
                                                                <td>@padrones[i].ValorMejora</td>
                                                                <td id="Vig_Desde_VP">
                                                                    @(padrones[i].Fecha_Vigencia_Desde.HasValue ? padrones[i].Fecha_Vigencia_Desde.Value.ToString("dd/MM/yyyy") : "-")
                                                                </td>
                                                                <td id="Vig_Hasta_VP">
                                                                    @(padrones[i].Fecha_Vigencia_Hasta.HasValue ? padrones[i].Fecha_Vigencia_Hasta.Value.ToString("dd/MM/yyyy") : "-")
                                                                </td>
                                                            </tr>

                                                        }
                                                    }

                                                </tbody>
                                            </table>

                                        </div>
                                        <div class="col-lg-4 col-xs-4 col-sm-4 col-md-4">
                                            @if (SeguridadController.ExisteFuncion(@Resources.Seguridad.EditarValuacion))
                                            {
                                                <img id="BtnAgregar" title="Agregar" src="~/Content/images/Valuacion/icons/blue/32/crear.png" style="cursor:pointer" />
                                            }
                                        </div>
                                        <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12" style="height: 15px">
                                        </div>
                                        <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12">
                                            <span class="text-danger">VI = VP x PCP</span>
                                        </div>

                                        <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12">
                                            <table id="Grilla_VI" class="table table-striped table-bordered table-responsive" cellspacing="0" style="width:100%">
                                                <thead>
                                                    <tr>
                                                        <th>id</th>
                                                        <th>Partida Mun.</th>
                                                        <th>Partida Prov.</th>
                                                        @*<th>Año</th>*@
                                                        <th>VI</th>
                                                        <th>VP</th>
                                                        <th>PCP</th>
                                                        <th>Vig. Desde</th>
                                                        <th>Vig. Hasta</th>
                                                    </tr>
                                                </thead>
                                                <tbody>

                                                    @{
                                                        for (int i = 0; i < Model.EdicionParcela.listaVal.Count; i++)
                                                        {

                                                            //string Partida = "0001212/000" + i;
                                                            //        Decimal VP = Model.EdicionParcela.listaVal[i].ValorTierra * (Decimal.Parse(Model.EdicionParcela.listaVal[i].PorcentajeCodominio.ToString()) / 100);
                                                            //string PCP = "1/2";

                                                            <tr>
                                                                <td>@Model.EdicionParcela.listaVal[i].IdPadron</td>
                                                                <td>@Model.EdicionParcela.listaUts.Where(x => x.UnidadTributariaId == Model.EdicionParcela.listaVal[i].IdUnidadTributaria).FirstOrDefault().CodigoMunicipal @Html.HiddenFor(model => model.EdicionParcela.listaVal[i].IdUnidadTributaria)</td>
                                                                <td>@Model.EdicionParcela.listaUts.Where(x => x.UnidadTributariaId == Model.EdicionParcela.listaVal[i].IdUnidadTributaria).FirstOrDefault().CodigoProvincial</td>
                                                                <td>@(Model.EdicionParcela.listaVal[i].ValorTierraPropiedad + Model.EdicionParcela.listaVal[i].ValorMejoraPropiedad)</td>
                                                                <td>@(Model.EdicionParcela.listaVal[i].ValorTotal)</td>
                                                                <td>@Model.EdicionParcela.listaUts.Where(x => x.UnidadTributariaId == Model.EdicionParcela.listaVal[i].IdUnidadTributaria).FirstOrDefault().PorcentajeCopropiedad %</td>

                                                                <td id="Vig_Desde_VI_@i">
                                                                    @(Model.EdicionParcela.listaVal[i].Fecha_Vigencia_Desde.HasValue ? Model.EdicionParcela.listaVal[i].Fecha_Vigencia_Desde.Value.ToString("dd/MM/yyyy") : "-")
                                                                </td>
                                                                <td id="Vig_Hasta_VI_@i">
                                                                    @(Model.EdicionParcela.listaVal[i].Fecha_Vigencia_Hasta.HasValue ? Model.EdicionParcela.listaVal[i].Fecha_Vigencia_Hasta.Value.ToString("dd/MM/yyyy") : "-")
                                                                </td>
                                                            </tr>
                                                        }

                                                    }
                                                </tbody>
                                            </table>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div id="accordion">
                            <div class="panel-group panel-primary">
                                <div class="panel-heading panel-desactivado" id="PanelValuacion" style="height:40px;">
                                    <div class="col-lg-11 col-xs-11 col-sm-11 col-md-11 sin-padding">
                                        Nueva Valuación
                                    </div>
                                    <div class="col-lg-1 col-xs-1 col-sm-1 col-md-1 text-right ">
                                        <span id="Flecha_Valuacion2" class="glyphicon glyphicon-triangle-bottom flecha-desactivada flecha" style="cursor:pointer"></span>

                                    </div>
                                </div>
                                <div id="accordion_panel_2" class="panel-collapse collapse " aria-expanded="true" style="border: solid; border-width: 1px; border-color: #a5a5a5; color: #000000">
                                    <div class="panel-body" style="padding: 5px 0 5px 0; ">
                                        <div class="panel-body" style="color:black" id="Panel_Grilla_Tierra">

                                            <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12">
                                                @if (Model.EdicionParcela.ValModulos)
                                                {
                                                    <span class="text-danger">Tierra (VT = Cant. Módulos x C1 x C2 x C3 x C4)</span>
                                                }
                                                else
                                                {
                                                    <span class="text-danger">Tierra (VT = Med. x VB x C1 x C2 x C3 x C4)</span>
                                                }

                                            </div>
                                            <div class="col-lg-10 col-xs-10 col-sm-10 col-md-10">
                                                <table id="Grilla_Tierra" class="table table-striped table-bordered table-responsive" cellspacing="0" style="width:100%">
                                                    <thead>
                                                        <tr>
                                                            <th>Valor</th>
                                                            <th>Zona</th>
                                                            <th>Medida(Sup)</th>
                                                            @if (Model.EdicionParcela.ValModulos)
                                                            {
                                                                <th>Cant. Módulos</th>
                                                                <th>C1: Val. Mod.</th>
                                                            }
                                                            else
                                                            {
                                                                <th>Val. M2</th>
                                                                <th>C1</th>
                                                            }

                                                            <th>C2</th>
                                                            <th>C3</th>
                                                            <th>C4</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>

                                                        @{
        for (int i = 1; i < 2; i++)
        {

            <tr>
                <td id="valorTierra">@Model.EdicionParcela.ValorTierra</td>
                <td>@Model.EdicionParcela.Desc_Zona_Atributo</td>
                <td id="MedidaTierra">@Model.EdicionParcela.Medida </td>

                @if (Model.EdicionParcela.ValModulos)
                {
                    <td id="cantidadModulos">@Model.EdicionParcela.CantModulos</td>
                }
                else
                {
                    <td id="ValorBasico">@Model.EdicionParcela.ValorMetro2</td>
                }
                <td id="C1T">@Model.EdicionParcela.C1T</td>
                <td id="C2T">@Model.EdicionParcela.C2T</td>
                <td id="C3T">@Model.EdicionParcela.C3T</td>
                <td id="C4T">@Model.EdicionParcela.C4T</td>
            </tr>

        }

                                                        }

                                                    </tbody>
                                                </table>
                                            </div>
                                            @Html.HiddenFor(model => model.EdicionParcela.ValorTierra)

                                        </div>

                                        <div class="panel-body" style="color:black" id="Panel_Grilla_Mejoras">

                                            <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12">
                                                <span class="text-danger">Mejoras (VM = Med x VB x C1 x C2 x C3 x C4), donde Med. = Sup. Cub. + (Sup.SemiCub. x Coef.SemiCub.)</span>
                                            </div>
                                            <div class="form-group">
                                                <div class="col-lg-11 col-xs-11 col-sm-11 col-md-11">
                                                    <table id="Grilla_Mejoras" class="table table-striped table-bordered table-responsive" cellspacing="0">
                                                        <thead>
                                                            <tr>
                                                                <th></th>
                                                                <th>Valor</th>
                                                                @if (ViewBag.Parametro1MejoraTipo == "combo" || ViewBag.Parametro1MejoraTipo == "texto" || ViewBag.Parametro1MejoraTipo == "comparador")
                                                                {
                                                                    <th>@ViewBag.Parametro1MejoraNombre</th>
                                                                }
                                                                @if (ViewBag.Parametro2MejoraTipo == "combo" || ViewBag.Parametro2MejoraTipo == "texto" || ViewBag.Parametro2MejoraTipo == "comparador")
                                                                {
                                                                    <th>@ViewBag.Parametro2MejoraNombre</th>
                                                                }
                                                                <th>Año</th>
                                                                <th>Sup. Total</th>
                                                                <th>Valor Básico</th>
                                                                <th>C1</th>
                                                                <th>C2</th>
                                                                <th>C3</th>
                                                                <th>C4</th>
                                                                <th>Coef. Semi.</th>
                                                                <th>Sup. Cub.</th>
                                                                <th>Sup. SemiCub.</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="tbody_Mejoras">

                                                            @{

                                                                Decimal valorMejora;
                                                                Decimal MedidaTotalMejora;
                                                                for (int i = 0; i < Model.EdicionParcela.listaMejoras.Count; i++)
                                                                {
                                                                    MedidaTotalMejora = Model.EdicionParcela.listaMejoras[i].Medida + Model.EdicionParcela.listaMejoras[i].MedidaSemiCubierta;
                                                                    if (Model.EdicionParcela.listaMejoras[i].MedidaSemiCubierta > 0)
                                                                    {
                                                                        valorMejora = (Model.EdicionParcela.listaMejoras[i].Medida + (Model.EdicionParcela.listaMejoras[i].MedidaSemiCubierta * (Model.EdicionParcela.listaMejoras[i].CoeficienteSemi / 100))) * Model.EdicionParcela.listaMejoras[i].ValorBasico * Model.EdicionParcela.listaMejoras[i].C1 * Model.EdicionParcela.listaMejoras[i].C2 * Model.EdicionParcela.listaMejoras[i].C3 * Model.EdicionParcela.listaMejoras[i].C4;
                                                                    }
                                                                    else
                                                                    {

                                                                        valorMejora = Model.EdicionParcela.listaMejoras[i].Medida * Model.EdicionParcela.listaMejoras[i].ValorBasico * Model.EdicionParcela.listaMejoras[i].C1 * Model.EdicionParcela.listaMejoras[i].C2 * Model.EdicionParcela.listaMejoras[i].C3 * Model.EdicionParcela.listaMejoras[i].C4;
                                                                    }

                                                                    long Id = Model.EdicionParcela.listaMejoras[i].MejoraID;
                                                                    <tr>
                                                                        <td class="no-sort"><input type="checkbox" id="chk_@Id" onchange="javascript:SeleccionarMejora(@Id)" />&ensp;@(i + 1) @Html.HiddenFor(model => Model.EdicionParcela.listaMejoras[i].MejoraID) @Html.HiddenFor(model => Model.EdicionParcela.listaMejoras[i].eliminar)</td>
                                                                        <td class="ValorMejora">@valorMejora.ToString("0.00")</td>
                                                                        @if (ViewBag.Parametro1MejoraTipo == "combo" || ViewBag.Parametro1MejoraTipo == "texto" || ViewBag.Parametro1MejoraTipo == "comparador")
                                                                        {
                                                                            <td>
                                                                                @{
                                                                            if (ViewBag.Parametro1MejoraTipo == "combo")
                                                                            {
                                                                                <select name="EdicionParcela.listaMejoras[@i].Parametro1" id="EdicionParcela_listaMejoras_a__Parametro1" data-val-required="The Parametro1 field is required." data-val-number="The field Parametro1 must be a number." data-val="true" class="form-control parametro1">

                                                                                    <option value=""></option>
                                                                                    @foreach (SelectListItem item in (SelectList)ViewBag.listaParametro1)
                                                                                    {

                                                                                        if (Model.EdicionParcela.listaMejoras[i].Parametro1 == item.Value)
                                                                                        {
                                                                                            <option value="@item.Value" selected>@item.Text</option>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <option value="@item.Value">@item.Text</option>
                                                                                        }
                                                                                    }


                                                                                </select>
                                                                            }
                                                                            else if (ViewBag.Parametro1MejoraTipo == "texto" || ViewBag.Parametro1MejoraTipo == "comparador")
                                                                            {
                                                                                <input type="text" value="@Model.EdicionParcela.listaMejoras[i].Parametro1" name="EdicionParcela.listaMejoras[@i].Parametro1" id="EdicionParcela_listaMejoras_a__Parametro1" class="form-control ">
                                                                            }
                                                                                }






                                                                            </td>
                                                                        }
                                                                        @if (ViewBag.Parametro2MejoraTipo == "combo" || ViewBag.Parametro2MejoraTipo == "texto" || ViewBag.Parametro2MejoraTipo == "comparador")
                                                                        {
                                                                            <td>
                                                                                @{
                                                                            if (ViewBag.Parametro2MejoraTipo == "combo")
                                                                            {
                                                                                <select name="EdicionParcela.listaMejoras[@i].Parametro2" id="EdicionParcela_listaMejoras_a__Parametro2" data-val-required="The Parametro2 field is required." data-val-number="The field Parametro2 must be a number." data-val="true" class="form-control parametro2">
                                                                                    <option value=""></option>
                                                                                    @foreach (SelectListItem item in (SelectList)ViewBag.listaParametro2)
                                                                                    {
                                                                                        if (Model.EdicionParcela.listaMejoras[i].Parametro2 == item.Value)
                                                                                        {
                                                                                            <option value="@item.Value" selected>@item.Text</option>
                                                                                        }
                                                                                        else
                                                                                        {
                                                                                            <option value="@item.Value">@item.Text</option>}
                                                                                    }


                                                                                </select>
                                                                            }
                                                                            else if (ViewBag.Parametro2MejoraTipo == "texto" || ViewBag.Parametro2MejoraTipo == "comparador")
                                                                            {
                                                                                <input type="text" value="@Model.EdicionParcela.listaMejoras[i].Parametro2" name="EdicionParcela.listaMejoras[@i].Parametro2" id="EdicionParcela_listaMejoras_a__Parametro2" class="form-control">
                                                                            }

                                                                                }
                                                                            </td>
                                                                        }

                                                                        @*<td>@Html.DropDownListFor(model => model.EdicionParcela.listaMejoras[i].Parametro1, (SelectList)ViewBag.listaParametro1, new { @class = "form-control" })</td>
                                                                            <td>@Html.DropDownListFor(model => model.EdicionParcela.listaMejoras[i].Parametro2, (SelectList)ViewBag.listaParametro2, new { @class = "form-control parametro2" })</td>*@
                                                                        <td>@Html.TextBoxFor(model => model.EdicionParcela.listaMejoras[i].Anio, new { @class = "form-control anio" })</td>
                                                                        <td>@Html.TextBox("MedidaTotalMejora", MedidaTotalMejora, new { @readonly = "readonly", @class = "form-control MedidaMejora" })</td>
                                                                        <td class="valorBasicoMejora">@Model.EdicionParcela.listaMejoras[i].ValorBasico</td>
                                                                        <td class="c1m">@Model.EdicionParcela.listaMejoras[i].C1</td>
                                                                        <td class="c2m">@Model.EdicionParcela.listaMejoras[i].C2</td>
                                                                        <td class="c3m">@Model.EdicionParcela.listaMejoras[i].C3</td>
                                                                        <td class="c4m">@Model.EdicionParcela.listaMejoras[i].C4</td>
                                                                        <td class="coef">@Model.EdicionParcela.listaMejoras[i].CoeficienteSemi</td>
                                                                        <td>@Html.TextBoxFor(model => model.EdicionParcela.listaMejoras[i].Medida, new { @class = "form-control cubierta" })</td>
                                                                        <td>@Html.TextBoxFor(model => model.EdicionParcela.listaMejoras[i].MedidaSemiCubierta, new { @class = "form-control semicubierta" })</td>
                                                                    </tr>

                                                                }

                                                            }

                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="col-xs-1 pull-right" style="width:5%">
                                                    <dl class="pull-right">

                                                        <dt><span class="glyphicon glyphicon-2x glyphicon-plus-sign  " aria-hidden="true" style="font-size:20px; cursor:pointer" id="btn_AgregarMejora"></span></dt>
                                                        <dt><span class="glyphicon glyphicon-2x glyphicon-minus-sign " aria-hidden="true" style="font-size:20px; cursor:pointer" id="btn_EliminarMejora"></span></dt>




                                                    </dl>
                                                </div>
                                            </div>

                                            <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12" style="margin-top:10px">

                                            </div>

                                            <div class="col-lg-8 col-xs-8 col-sm-8 col-md-8">
                                                Total Parcela ( $@Html.Label("VP", (Model.EdicionParcela.ValorTierra + Model.EdicionParcela.ValorMejoras).ToString("0.00"), new { @id = "ValorPropiedadLabel" }) ) = Valor Tierra ( $@Html.LabelFor(model => model.EdicionParcela.ValorMejoras, Model.EdicionParcela.ValorTierra.ToString("0.00"), new { @id = "ValorTierraLabel" }) ) + Valor Mejora ( $@Html.LabelFor(model => model.EdicionParcela.ValorMejoras, Model.EdicionParcela.ValorMejoras.ToString("0.00"), new { @id = "ValorMejorasLabel" }) )
                                                @Html.HiddenFor(model => model.EdicionParcela.ValorMejoras, new { @id = "ValorTotalMejoras" });
                                                @*<h5 class="escala_fuente_14">Total Mejoras $ = @Html.LabelFor(model => model.EdicionParcela.ValorMejoras, Model.EdicionParcela.ValorMejoras.ToString("0.00"), new { @id = "ValorTotalMejoras" })</h5>*@
                                            </div>
                                            @*<div class="col-lg-2 col-xs-2 col-sm-2 col-md-2" style="padding-left:0px">
                                                    @Html.LabelFor(model => model.EdicionParcela.ValorMejoras, Model.EdicionParcela.ValorTierra.ToString("0.00"))
                                                </div>*@
                                            <div class="col-lg-12 col-xs-12 col-sm-12 col-md-12 text-right" style="margin-top:10px">
                                                <img id="BtnCalcular" title="recalcular" src="~/Content/images/Valuacion/icons/blue/32/restaurar.png" style="cursor:pointer; margin-right: 5px" />
                                                <img id="BtnGrabarNuevo" title="Grabar" src="~/Content/images/Valuacion/icons/blue/32/save.png" style="cursor:pointer; display:none; margin-right: 5px" />
                                                <img id="btnCancelarNuevo" title="Cancelar" src="~/Content/images/Seguridad/icons/blue/32/cancelar.png" style="cursor:pointer;">
                                            </div>
                                        </div>





                                    </div>
                                </div>
                            </div>

                        </div>



                    </div>
                    @*Fin de Grillas*@

                </div>
                @*BOTONES*@
                <div class="modal-footer color-fondo-footer" style="background-color:#ffffff;" id="Panel_Botones">
                    <img id="btnCancelar" title="Cancelar" src="~/Content/images/Seguridad/icons/blue/32/cancelar.png" style="cursor:pointer;">
                </div>

            </div>
        </div>
    }
</div>
<!-- Modal Fechas-->
<div class="modal fade" id="ModalFechas" tabindex="-3" role="dialog" aria-labelledby="TituloFechas" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title col-lg-11 col-xs-11 col-sm-11 col-md-11" style="color:#000000;" id="TituloFechas">Titulo Fechas</h4>
                <br />
            </div>
            <div class="modal-body" id="body_Fechas">
                <div id="accordion_panel_Fechas" class="panel-collapse collapse in" aria-expanded="true" style="border: solid; border-width: 1px; border-color: #a5a5a5; color: #000000">
                    <div class="panel-body">

                        <input type="hidden" id="Id_Fecha_Editar" value="" />
                        <input type="hidden" id="TipoFecha" value="" />
                        <div class="col-lg-4 col-xs-4 col-sm-4 col-md-4 " id="div_Descricpion_Fechas">

                        </div>

                        <div class="input-group date col-lg-6 col-xs-6 col-sm-6 col-md-6" id="FechaEdicion">
                            <input type="text" class="form-control" />
                            <span class="input-group-addon">
                                <span class="glyphicon glyphicon-calendar">
                                </span>
                            </span>
                        </div>

                        <div class="col-lg-2 col-xs-2 col-sm-2 col-md-2 ">
                        </div>

                    </div>
                </div>

            </div>
            <div class="modal-footer" style="background-color:#ffffff;" id="Panel_Botones">
                <img id="btnEdicionFechaOK" data-dismiss="modal" class="" title="Aceptar" src="~/Content/images/Seguridad/icons/blue/32/checkbox.png" style="cursor:pointer;">&ensp;&ensp;
                <img id="btnEdicionFechaCancelar" data-dismiss="modal" title="Cancelar" src="~/Content/images/Seguridad/icons/blue/32/cancelar.png" style="cursor:pointer;">
            </div>
        </div>
    </div>
</div>


<!-- Modal Advertencia-->
<div class="modal fade" id="ModalAdvertencia" tabindex="-2" role="dialog" aria-labelledby="TituloAdvertencia" aria-hidden="true" data-backdrop="static" data-board="false" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <input type="hidden" id="TipoAdvertencia" value="" />
                <h4 class="modal-title col-lg-11 col-xs-11 col-sm-11 col-md-11" id="TituloAdvertencia" style="color:#000000;">Titulo</h4>
                <br />
            </div>
            <div class="modal-body">
                <div id="MensajeAlerta" class="alert alert-warning alert-dismissible" role="alert">
                    <strong>Atención!</strong><br />
                    <p id="DescripcionAdvertencia">an <br />Está seguro de continuar?</p>
                </div>
            </div>
            <div class="modal-footer" style="background-color:#ffffff;" id="Panel_Botones">
                <img id="btnAdvertenciaOK" data-dismiss="modal" class="" title="Aceptar" src="~/Content/images/Seguridad/icons/blue/32/checkbox.png" style="cursor:pointer;">&ensp;&ensp;
                <img id="btnCancelarAdvertencia" data-dismiss="modal" title="Cancelar" src="~/Content/images/Seguridad/icons/blue/32/cancelar.png" style="cursor:pointer;">
            </div>
        </div>
    </div>
</div>

<!-- Modal Información-->
<div class="modal fade" id="ModalInfo" tabindex="-3" role="dialog" aria-labelledby="TituloInfo" aria-hidden="true" data-backdrop="static" data-keyboard="false">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <input type="hidden" id="TipoInformacion" value="" />
                <h4 class="modal-title col-lg-11 col-xs-11 col-sm-11 col-md-11" id="TituloInfo" style="color:#000000;">Titulo</h4>
                <br />
            </div>
            <div class="modal-body">
                <div id="MensajeInfo" class="alert alert-success alert-dismissible" role="alert">
                    <strong>Atención!</strong><br />
                    <p id="DescripcionInfo">Descripcion de la informacion</p>
                </div>
            </div>
            <div class="modal-footer" style="background-color:#ffffff;" id="Panel_Botones">
                <img id="btnCancelarInfo" data-dismiss="modal" title="Cancelar" src="~/Content/images/Seguridad/icons/blue/32/checkbox.png" style="cursor:pointer;">
            </div>
        </div>
    </div>
</div>

@using (Html.BeginForm("DetalleValuacionParcela", "Valuacion", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { id = "formcancelar", role = "form", novalidate = "", autocomplete = "off" }))
{  @Html.AntiForgeryToken()
    <input type="hidden" id="Inmueble" name="idParcela" value="@Model.EdicionParcela.Id_Parcela">
}

<div id="valuacion-externo-container"></div>

<script src="~/Scripts/jquery.dataTables.js"></script>
<script src="~/Scripts/formValidation.min.js"></script>
<script src="~/Scripts/bootstrapValidation.min.js"></script>
<script src="~/Scripts/select2.js"></script>

<script src="~/Scripts/jquery.inputmask.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.inputmask.numeric.extensions.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.inputmask.date.extensions.js" type="text/javascript"></script>

<script src="~/Scripts/moment-with-locales.js" type="text/javascript"></script>
<script src="~/Scripts/bootstrap-datetimepicker.js" type="text/javascript"></script>
<script src="~/Scripts/jquery.form.js"></script>

<script>

    var CantidadRegistros = 0;


    $(window).keydown(function (event) {
        if (event.keyCode == 13) {
            event.preventDefault();
            return false;
        }
    });



    $(window).resize(ajustamodal);
    function ajustamodal() {
        var altura = $(window).height() - 190; //value corresponding to the modal heading + footer
        $(".modal-body-scroll").css({ "height": altura, "overflow-y": "auto" });
    }


    $(document).ready(function () {
        $("#Grilla_VP tbody tr").click(function () {

            $("#Grilla_VI").DataTable().columns(0).search($(this).find("#idPadron").val()).draw();
            $("#Grilla_VI").DataTable().columns(4).search($(this).find("#cValortotal").html().trim()).draw();
            $("#Grilla_VI").DataTable().columns(6).search($(this).find("#Vig_Desde_VP").html().trim()).draw();
            $("#Grilla_VI").DataTable().columns(7).search($(this).find("#Vig_Hasta_VP").html().trim()).draw();
        });
        $(".flecha").click(function () {

            var esto = $(this);
            if (!esto.hasClass("flecha-desactivada")) {
                var acordion = $(this).parent().parent().parent().children('.collapse').first();
                if (acordion.hasClass("in") == false) {
                    acordion.addClass("in");
                    esto.removeClass("glyphicon-triangle-bottom");
                    esto.addClass("glyphicon-triangle-top");
                } else {
                    acordion.removeClass("in");
                    esto.addClass("glyphicon-triangle-bottom");
                    esto.removeClass("glyphicon-triangle-top");
                }
            }
        });

        ajustamodal();
        GeoSIT.SeleccionPersonas = {        
            mappings: [],
            pendientes: [],
            accepted: false,
            updateCallback: actualizarResponsableFiscal,
            acceptCallback: function () { $("#form").submit(); }
        };
        var responsablesFiscales = @Html.Raw(Json.Encode(Model.ResponsablesFiscales));

        //$("#BtnCalcular").click(function () {
        //    var coef = 0;
        //    if ($("#cantidadModulos").html() != undefined) {
        //        coef = parseFloat($("#cantidadModulos").html());
        //    } else {
        //        coef = parseFloat($("#ValorBasico").html()) * parseFloat($("#MedidaTierra").html());
        //    }
        //    var valor = coef * parseFloat($("#C1T").html()) * parseFloat($("#C2T").html()) * parseFloat($("#C3T").html()) * parseFloat($("#C4T").html());
        //    $("#valorTierra").html(valor.toFixed(2));
        //    $("#EdicionParcela_ValorTierra").val(valor.toFixed(2));
        //});


        $("#tbody_Mejoras").on('keyup', '.cubierta', function () {
            //$(".cubierta").keyup(function () {
            var tr = $(this).parent().parent();
            var c1 = parseFloat(tr.find('.c1m').html());
            var c2 = parseFloat(tr.find('.c2m').html());
            var c3 = parseFloat(tr.find('.c3m').html());
            var c4 = parseFloat(tr.find('.c4m').html());
            var coef = parseFloat(tr.find('.coef').html());

            var cubierta = parseFloat($(this).val());
            var semicubierta = parseFloat(tr.find('.semicubierta').val());
            var valorBasico = parseFloat(tr.find('.valorBasicoMejora').html());
            if (isNaN(semicubierta)) {
                semicubierta = 0;
            }
            if (isNaN(cubierta)) {
                cubierta = 0;
            }
            
            var tipoMuni;
            tr.find('.MedidaMejora').val(cubierta + semicubierta);

            var valor = (cubierta + (semicubierta * (coef / 100))) * valorBasico * c1 * c2 * c3 * c4;
            tr.find(".ValorMejora").html(valor.toFixed(2));
            var valorTotal = parseFloat(0.00);
            $(".ValorMejora").each(function (i, elem) {
                valorTotal += parseFloat($(elem).html());
            });
            $("#ValorMejorasLabel").html(valorTotal.toFixed(2));
            $("#ValorTotalMejoras").val(valorTotal.toFixed(2));
            $("#ValorPropiedadLabel").html((parseFloat($("#EdicionParcela_ValorTierra").val()) + valorTotal).toFixed(2));

        });
        $("#tbody_Mejoras").on('keyup', '.semicubierta', function () {
            var tr = $(this).parent().parent();
            var c1 = parseFloat(tr.find('.c1m').html());
            var c2 = parseFloat(tr.find('.c2m').html());
            var c3 = parseFloat(tr.find('.c3m').html());
            var c4 = parseFloat(tr.find('.c4m').html());
            var coef = parseFloat(tr.find('.coef').html());
            var semicubierta = parseFloat($(this).val());
            var cubierta = parseFloat(tr.find('.cubierta').val());
            var valorBasico = parseFloat(tr.find('.valorBasicoMejora').html());
            if (isNaN(semicubierta)) {
                semicubierta = 0;
            }
            if (isNaN(cubierta)) {
                cubierta = 0;
            }
            tr.find('.MedidaMejora').val(cubierta + semicubierta);

            var valor = (cubierta + (semicubierta * (coef / 100))) * valorBasico * c1 * c2 * c3 * c4;
            tr.find(".ValorMejora").html(valor.toFixed(2));
            var valorTotal = parseFloat(0.00);
            $(".ValorMejora").each(function (i, elem) {
                valorTotal += parseFloat($(elem).html());
            });
            $("#ValorTotalMejoras").val((valorTotal.toFixed(2)));
            $("#ValorMejorasLabel").html((valorTotal.toFixed(2)));
            $("#ValorPropiedadLabel").html((parseFloat($("#EdicionParcela_ValorTierra").val()) + valorTotal).toFixed(2));


        });

        $('#Grilla_VI').dataTable({
            "scrollY": "210px",
            "scrollCollapse": true,
            "paging": false,
            "searching": true,
            "bInfo": false,
            "aaSorting": [[7, 'asc']],
            "language": {
                "url": BASE_URL + "Scripts/dataTables.spanish.txt"
            },
            "columnDefs": [{
                "targets": 'no-sort',
                "orderable": false,
            },
            {
                "targets": [0, 6, 7],
                "visible": false
            }],
            "bAutoWidth": false, // Disable the auto width calculation
            "columns": [
                { "width": "15%", "bSortable": false },
                { "width": "15%", "bSortable": false },
                { "width": "15%", "bSortable": false },
                //{ "width": "3%", "bSortable": false },
                { "width": "15%", "bSortable": false },
                { "width": "15%", "bSortable": false },
                { "width": "3%", "bSortable": false }
                ,
                { "width": "17%", "bSortable": false },
                { "width": "17%", "bSortable": false }

            ]
        });

        $('#Grilla_VP').dataTable({
            "scrollY": "210px",
            "scrollCollapse": true,
            "paging": false,
            "searching": true,
            "bInfo": false,
            //"aaSorting": [[3, 'desc'], [4, 'asc']],
            "aaSorting": [[0, 'desc']],
            "language": {
                "url": BASE_URL + "Scripts/dataTables.spanish.txt"
            },
            "columnDefs": [{
                "targets": 'no-sort',
                "orderable": false,
            },
            {
                "targets": [0],
                "visible": false
            }],
            "bAutoWidth": false, // Disable the auto width calculation
            "columns": [
                { "width": "5%", "bSortable": false },
                { "width": "20%", "bSortable": false },
                { "width": "20%", "bSortable": false },
                { "width": "15%", "bSortable": false },
                { "width": "20%", "bSortable": false },
                { "width": "20%", "bSortable": false }

            ]
        });
        $("#Grilla_VP").DataTable().draw();
        $("#Grilla_VI").DataTable().columns(7).search("-").draw();

        $('#Grilla_Tierra').dataTable({
            //"scrollY": "100px",
            //"scrollCollapse": true,
            "paging": false,
            "searching": true,
            "bInfo": false,
            //"aaSorting": [[1, 'asc']],
            "language": {
                "url": BASE_URL + "Scripts/dataTables.spanish.txt"
            },
            "columnDefs": [{
                "targets": 'no-sort',
                "orderable": false,
            }],
            "bAutoWidth": false, // Disable the auto width calculation
            "columns": [
                { "width": "15%", "bSortable": false },
                { "width": "25%", "bSortable": false },
                { "width": "20%", "bSortable": false },
                { "width": "20%", "bSortable": false },
                { "width": "5%", "bSortable": false },
                { "width": "5%", "bSortable": false },
                { "width": "5%", "bSortable": false },
                { "width": "5%", "bSortable": false }


            ]
        });

        $('#Grilla_Mejoras').dataTable({
            "scrollX": true,
            "paging": false,
            "searching": true,
            "bInfo": false,
            "language": {
                "url": BASE_URL + "Scripts/dataTables.spanish.txt"
            },
            "columnDefs": [{
                "targets": 'no-sort',
                "orderable": false,
            }],
            "columns": [
                { "width": "5px", "bSortable": false }, //id
                { "width": "10%", "bSortable": false },//valor
                @if (ViewBag.Parametro1MejoraTipo == "combo" || ViewBag.Parametro1MejoraTipo == "texto" || ViewBag.Parametro1MejoraTipo == "comparador") {
                    <text>
                { "width": "12%", "bSortable": false },//tipo
                </text>
                }
                @if (ViewBag.Parametro2MejoraTipo == "combo" || ViewBag.Parametro2MejoraTipo == "texto" || ViewBag.Parametro2MejoraTipo == "comparador") {
                    <text>
                { "width": "8%", "bSortable": false },//categoria
                </text>
                }

                { "width": "6%", "bSortable": false },//anio
                { "width": "10%", "bSortable": false },//subtotal
                { "width": "6%", "bSortable": false },//valorbasico
                { "width": "2%", "bSortable": false },//coef 1
                { "width": "2%", "bSortable": false },//coef 2
                { "width": "2%", "bSortable": false },//coef 3
                { "width": "2%", "bSortable": false },//coef 4
                { "width": "1%", "bSortable": false },//semicub
                { "width": "10%", "bSortable": false },//sup cub
                { "width": "10%", "bSortable": false }//sup semicub


            ]
        });

        $.ajax({
            url: '@Url.Action("GetTipoMunicipalidad", "Valuacion")',
            success: function (data) {
                tipoMuni = data;
            },
            error: function (error) {
                alert(error.responseText);
            }
        });

        $("#tbody_Mejoras").on('change', '.anio', function () {

            var that = $(this);
            var aniotext = $(this).val();
            if (aniotext == "") {
                aniotext = 2015;
            }
            $.ajax({
                url: '@Url.Action("GetCoef1", "Valuacion")',
                data: { anio: aniotext },
                dataType: 'json',
                success: function (data) {
                    var tr = that.parent().parent();
                    tr.find('.c1m').html((data + ""));
                },
                error: function (error) {
                    alert(error.responseText);
                }
            });
        });
        @{ if (Model.MetodoValuacionMejora == "mejoravaloresbasicos" || Model.MetodoValuacionMejora == "superficiesemicubierta"){
                  <text>
        $("#tbody_Mejoras").on('change', '.parametro2', function () {

            var that = $(this);
            $.ajax({
                url: '@Url.Action("GetValorBasicoMejoraByIdEstado", "Valuacion")',
                data: { id: $(this).val() },
                //dataType: 'json',
                success: function (data) {
                    var tr = that.parent().parent();
                    tr.find('.coef').html(data.Semicubierto);
                    tr.find('.valorBasicoMejora').html(data.Coeficiente);

                    var c1 = parseFloat(tr.find('.c1m').html());
                    var c2 = parseFloat(tr.find('.c2m').html());
                    var c3 = parseFloat(tr.find('.c3m').html());
                    var c4 = parseFloat(tr.find('.c4m').html());
                    var coef = parseFloat(tr.find('.coef').html());
                    var semicubierta = parseFloat(tr.find('.semicubierta').val());
                    var cubierta = parseFloat(tr.find('.cubierta').val());
                    var valorBasico = parseFloat(tr.find('.valorBasicoMejora').html());
                    if (isNaN(semicubierta)) {
                        semicubierta = 0;
                    }
                    if (isNaN(cubierta)) {
                        cubierta = 0;
                    }
                    tr.find('.MedidaMejora').val(cubierta + semicubierta);

                    var valor = (cubierta + (semicubierta * (coef / 100))) * valorBasico * c1 * c2 * c3 * c4;
                    tr.find(".ValorMejora").html(valor.toFixed(2));
                    var valorTotal = parseFloat(0.00);
                    $(".ValorMejora").each(function (i, elem) {
                        valorTotal += parseFloat($(elem).html());
                    });
                    $("#ValorTotalMejoras").val((valorTotal.toFixed(2)));
                    $("#ValorMejorasLabel").html((valorTotal.toFixed(2)));
                    $("#ValorPropiedadLabel").html((parseFloat($("#EdicionParcela_ValorTierra").val()) + valorTotal).toFixed(2));

                },
                error: function (error) {
                    alert(error.responseText);
                }
            });
        });
        </text>
            } else{

                   <text>
        $("#tbody_Mejoras").on('change', '.parametro1', function () {

            var that = $(this);
            var val2 = $(this).parent().parent().find(".parametro2").val();
            $.ajax({
                url: '@Url.Action("GetValorBasicoMejoraByParam", "Valuacion")',
                data: { parametro1: $(this).val(), parametro2: val2 },
                //dataType: 'json',
                success: function (data) {
                    var tr = that.parent().parent();

                    tr.find('.valorBasicoMejora').html(data.ValorBasicoMejora);

                    var c1 = parseFloat(tr.find('.c1m').html());
                    var c2 = parseFloat(tr.find('.c2m').html());
                    var c3 = parseFloat(tr.find('.c3m').html());
                    var c4 = parseFloat(tr.find('.c4m').html());
                    var coef = parseFloat(tr.find('.coef').html());
                    var semicubierta = parseFloat(tr.find('.semicubierta').val());
                    var cubierta = parseFloat(tr.find('.cubierta').val());
                    var valorBasico = parseFloat(tr.find('.valorBasicoMejora').html());
                    if (isNaN(semicubierta)) {
                        semicubierta = 0;
                    }
                    if (isNaN(cubierta)) {
                        cubierta = 0;
                    }
                    tr.find('.MedidaMejora').val(cubierta + semicubierta);

                    var valor = (cubierta + (semicubierta * (coef / 100))) * valorBasico * c1 * c2 * c3 * c4;
                    tr.find(".ValorMejora").html(valor.toFixed(2));
                    var valorTotal = parseFloat(0.00);
                    $(".ValorMejora").each(function (i, elem) {
                        valorTotal += parseFloat($(elem).html());
                    });
                    $("#ValorTotalMejoras").val((valorTotal.toFixed(2)));
                    $("#ValorMejorasLabel").html((valorTotal.toFixed(2)));
                    $("#ValorPropiedadLabel").html((parseFloat($("#EdicionParcela_ValorTierra").val()) + valorTotal).toFixed(2));

                },
                error: function (error) {
                    alert(error.responseText);
                }
            });
        });
        $("#tbody_Mejoras").on('change', '.parametro2', function () {
            if (tipoMuni == 3 || tipoMuni == 2)
            {
                var that = $(this);
                var tr = that.parent().parent();
                $.ajax({
                    url: '@Url.Action("GetCoeficientes2", "Valuacion")',
                    data: { id: $(this).parent().parent().find(".parametro2 option:selected").val()},
                    //dataType: 'json',
                    success: function (data) {
                    
                        tr.find('.c2m').html((data));

                        var c1 = parseFloat(tr.find('.c1m').html());
                        var c2 = parseFloat(tr.find('.c2m').html());
                        var c3 = parseFloat(tr.find('.c3m').html());
                        var c4 = parseFloat(tr.find('.c4m').html());
                        var coef = parseFloat(tr.find('.coef').html());
                        var semicubierta = parseFloat(tr.find('.semicubierta').val());
                        var cubierta = parseFloat(tr.find('.cubierta').val());
                        var valorBasico = parseFloat(tr.find('.valorBasicoMejora').html());
                        if (isNaN(semicubierta)) {
                            semicubierta = 0;
                        }
                        if (isNaN(cubierta)) {
                            cubierta = 0;
                        }
                        tr.find('.MedidaMejora').val(cubierta + semicubierta);

                        var valor = (cubierta + (semicubierta * (coef / 100))) * valorBasico * c1 * c2 * c3 * c4;
                        tr.find(".ValorMejora").html(valor.toFixed(2));
                        var valorTotal = parseFloat(0.00);
                        $(".ValorMejora").each(function (i, elem) {
                            valorTotal += parseFloat($(elem).html());
                        });
                        $("#ValorTotalMejoras").val((valorTotal.toFixed(2)));
                        $("#ValorMejorasLabel").html((valorTotal.toFixed(2)));
                        $("#ValorPropiedadLabel").html((parseFloat($("#EdicionParcela_ValorTierra").val()) + valorTotal).toFixed(2));

                    },
                    error: function (error) {
                        alert(error.responseText);
                    }
                })
            }
            else
            {
                var that = $(this);
                var val1 = $(this).parent().parent().find(".parametro1").val();
                $.ajax({
                    url: '@Url.Action("GetValorBasicoMejoraByParam", "Valuacion")',
                    data: { parametro1: val1, parametro2: $(this).val() },
                    //dataType: 'json',
                    success: function (data) {
                        var tr = that.parent().parent();

                        tr.find('.valorBasicoMejora').html(data.ValorBasicoMejora);

                        var c1 = parseFloat(tr.find('.c1m').html());
                        var c2 = parseFloat(tr.find('.c2m').html());
                        var c3 = parseFloat(tr.find('.c3m').html());
                        var c4 = parseFloat(tr.find('.c4m').html());
                        var coef = parseFloat(tr.find('.coef').html());
                        var semicubierta = parseFloat(tr.find('.semicubierta').val());
                        var cubierta = parseFloat(tr.find('.cubierta').val());
                        var valorBasico = parseFloat(tr.find('.valorBasicoMejora').html());
                        if (isNaN(semicubierta)) {
                            semicubierta = 0;
                        }
                        if (isNaN(cubierta)) {
                            cubierta = 0;
                        }
                        tr.find('.MedidaMejora').val(cubierta + semicubierta);

                        var valor = (cubierta + (semicubierta * (coef / 100))) * valorBasico * c1 * c2 * c3 * c4;
                        tr.find(".ValorMejora").html(valor.toFixed(2));
                        var valorTotal = parseFloat(0.00);
                        $(".ValorMejora").each(function (i, elem) {
                            valorTotal += parseFloat($(elem).html());
                        });
                        $("#ValorTotalMejoras").val((valorTotal.toFixed(2)));
                        $("#ValorMejorasLabel").html((valorTotal.toFixed(2)));
                        $("#ValorPropiedadLabel").html((parseFloat($("#EdicionParcela_ValorTierra").val()) + valorTotal).toFixed(2));

                    },
                    error: function (error) {
                        alert(error.responseText);
                    }
                });
            }
        });
        </text>
            }
            }
        $('#FechaEdicion').datetimepicker({
            viewMode: "days",
            format: "DD/MM/YYYY",
            locale: "es",
        });

        $(".cubierta").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
        $(".semicubierta").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
        $(".anio").inputmask("y", {
            alias: "date",
            placeholder: "0000",
            yearrange: { minyear: 1800, maxyear: (new Date()).getFullYear() }
        });
        MostrarMensaje();
        $('#myModal').on('shown.bs.modal', function (e) {            
            $('#Grilla_VI').dataTable().api().columns.adjust();
            ajustarColumnasVP();
        });

        $('#myModal').modal('show');
        //$('#Grilla_Tierra').DataTable().columns.adjust().draw();

        $("#btn_AgregarMejora").click(function () {
            //console.log("OK")
            var t = $('#Grilla_Mejoras').DataTable();
            if ($(".ValorMejora") != undefined) {
                CantidadRegistros = $(".ValorMejora").size();
            }
            t.row.add([
            '<input type="checkbox" onchange="javascript:SeleccionarMejora(' + CantidadRegistros + ')" id="chk_' + CantidadRegistros + '">&ensp;' + (CantidadRegistros + 1),
            '<div class="ValorMejora">0</div>',
            @{
                    if (ViewBag.Parametro1MejoraTipo == "combo") {

                        <text>
                        ' <select name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].Parametro1" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__Parametro1" data-val-required="The Parametro1 field is required." data-val-number="The field Parametro1 must be a number." data-val="true" class="form-control parametro1">' +
                        '<option value=""></option>' +
                         @foreach (SelectListItem item in (SelectList)ViewBag.listaParametro1)
                            {
                                <text>
                                   '<option value="@item.Value">@item.Text</option>' +
                                </text>
                            }
                        '</select>',
                        </text>
                    }
                    else if (ViewBag.Parametro1MejoraTipo == "texto" || ViewBag.Parametro1MejoraTipo == "comparador")
                    {
                        <text>
                                '<input type="text" value="@string.Empty" name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].Parametro1" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__Parametro1" class="form-control">',
                            </text>
                    }


                if (ViewBag.Parametro2MejoraTipo == "combo") {

                        <text>
                    '<select name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].Parametro2" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__Parametro2" data-val-required="The Parametro2 field is required." data-val-number="The field Parametro2 must be a number." data-val="true" class="form-control parametro2">' +
                    //'<option value=""></option>' +
            @foreach (SelectListItem item in (SelectList)ViewBag.listaParametro2)
                            {
                                <text>
                                     '<option value="@item.Value">@item.Text</option>' +
                                </text>
                            }

                     '</select>',
            </text>
          }else if (ViewBag.Parametro2MejoraTipo == "texto" ||  ViewBag.Parametro2MejoraTipo == "comparador"){
                    <text>
                    '<input type="text" value="@string.Empty" name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].Parametro2" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__Parametro2" class="form-control">',
            </text>
          }
        }
        '<input type="text" value="@System.DateTime.Now.Year" name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].Anio" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__Anio" data-val-required="The Anio field is required." data-val-number="The field Anio must be a number." data-val="true" class="form-control anio">',
        '<input type="text" value="0" readonly="readonly" name="MedidaTotalMejora" id="MedidaTotalMejora" class="form-control MedidaMejora">',

        '<div class="valorBasicoMejora">@Model.EdicionParcela.ValorBasicoMejora</div>',

            '<div class="c1m">@Model.EdicionParcela.C1M</div>',
            '<div class="c2m">@Model.EdicionParcela.C2M</div>',
            '<div class="c3m">@Model.EdicionParcela.C3M</div>',
            '<div class="c4m">@Model.EdicionParcela.C4M</div>',
            '<div class="coef">@Model.EdicionParcela.CoefSemiC</div>',
            '<input type="text" value="0" name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].Medida" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__Medida" data-val-required="The Medida field is required." data-val-number="The field Medida must be a number." data-val="true" class="form-control cubierta">',
            '<input type="text" value="0" name="EdicionParcela.listaMejoras[' + CantidadRegistros + '].MedidaSemiCubierta" id="EdicionParcela_listaMejoras_' + CantidadRegistros + '__MedidaSemiCubierta" data-val-required="The MedidaSemiCubierta field is required." data-val-number="The field MedidaSemiCubierta must be a number." data-val="true" class="form-control semicubierta">'
            ]).draw();

            $(".cubierta").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $(".semicubierta").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $(".cm1").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $(".cm2").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $(".cm3").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $(".cm4").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $(".coef").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });

            $(".anio").inputmask("y", {
                alias: "date",
                placeholder: "0000",
                yearrange: { minyear: 1800, maxyear: (new Date()).getFullYear() }
            });
            @if (ViewBag.Parametro2MejoraTipo != "combo" && ViewBag.Parametro2MejoraTipo != "texto" && ViewBag.Parametro2MejoraTipo != "comparador" && ViewBag.Parametro2MejoraTipo != "combo" && ViewBag.Parametro2MejoraTipo != "texto" && ViewBag.Parametro2MejoraTipo != "comparador" ) {

               }
        });

        $("#btnEdicionFechaOK").click(function () {

            var Id_Fecha_Editar = $("#Id_Fecha_Editar").val();
            var TipoFecha = $("#TipoFecha").val();

            $("#FechaVig" + TipoFecha + "_" + Id_Fecha_Editar).val($('#FechaEdicion input').val())
            $("#Vig_" + TipoFecha + "_" + Id_Fecha_Editar).find('input').val($('#FechaEdicion input').val());
            $("#Vig_" + TipoFecha + "_" + Id_Fecha_Editar).find('div').html($('#FechaEdicion input').val() + '&ensp;&ensp; <img onclick="javascript: EditarFecha' + TipoFecha + '(' + Id_Fecha_Editar + ');"title="Editar Vigencia ' + TipoFecha + '" src="~/Content/images/Seguridad/icons/blue/16/editar.png" style="cursor:pointer;">');

        });

        $("#BtnAgregar").click(function () {
            $("#accordion_panel_2").addClass("in");

            $('#PanelValuacion').removeClass("panel-desactivado");
            $('#Flecha_Valuacion2').removeClass("flecha-desactivada");
            $('#Flecha_Valuacion2').addClass("flecha-activada");
            $('#Flecha_Valuacion1').addClass("flecha-desactivada");
            $('#Flecha_Valuacion1').removeClass("flecha-activada");
            $('#PanelValuacion0').addClass("panel-desactivado");
            $("#accordion_panel_1").removeClass("in");
            $('#Grilla_VP').DataTable().columns.adjust().draw();
            $('#Grilla_Mejoras').DataTable().columns.adjust().draw();
            $("#C1T").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $("#C2T").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $("#C3T").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });
            $("#C4T").inputmask('decimal', { digits: 2, rightAlign: false, radixPoint: '.' });


        });

        $("#BtnCalcular").click(function () {
            $("#BtnGrabarNuevo").show();
            var coef = 0;
            if ($("#cantidadModulos").html() != undefined) {
                coef = parseFloat($("#cantidadModulos").html());
            } else {
                coef = parseFloat($("#ValorBasico").html()) * parseFloat($("#MedidaTierra").html());
            }
            var valor = coef * parseFloat($("#C1T").html()) * parseFloat($("#C2T").html()) * parseFloat($("#C3T").html()) * parseFloat($("#C4T").html());
            $("#valorTierra").html(valor.toFixed(2));
            $("#EdicionParcela_ValorTierra").val(valor.toFixed(2));

            $("#ValorTierraLabel").html(valor.toFixed(2));

            var valorTotal = parseFloat(0.00);
            $(".ValorMejora").each(function (i, elem) {
                valorTotal += parseFloat($(elem).html());
            });
            $("#ValorMejorasLabel").html(valorTotal.toFixed(2));
            $("#ValorTotalMejoras").val(valorTotal.toFixed(2));
            $("#ValorPropiedadLabel").html((valor + valorTotal).toFixed(2))

            $('#Grilla_VP').DataTable().columns.adjust().draw();
            $('#Grilla_Mejoras').DataTable().columns.adjust().draw();


        });
        $("#btnCancelarNuevo").click(function () {

            var msj = "Está a punto de CANCELAR los cambios.<br>¿Está seguro de continuar?";
            $('#TituloAdvertencia').html("Advertencia - Cancelar")
            $('#DescripcionAdvertencia').html(msj)
            $('#ModalAdvertencia').modal('show')
            $("#btnAdvertenciaOK").click(function () {
                //  $("#formcancelar").submit();
                $('#myModal').modal('hide');
                loadView(BASE_URL + 'MantenimientoParcelario/EditarValuacion');
            });
        });

        $("#btn_EliminarMejora").click(function () {
            var msj = "Está a punto de ELIMINAR las mejoras seleccionadas.<br>¿Está seguro de continuar?";
            $('#TituloAdvertencia').html("Advertencia - Eliminar")
            $('#DescripcionAdvertencia').html(msj)
            $('#ModalAdvertencia').modal('show')
            $("#btnAdvertenciaOK").click(function () {

                var table = $('#Grilla_Mejoras').DataTable();
                CantidadRegistros = $(".ValorMejora").size();
                table.row('.selected').remove().draw();
                var indice = 0;
                $("#Grilla_Mejoras tbody tr").each(function () {

                    $(this).children("td").each(function () {
                        //PARA INPUTS
                        var inputHelp = $(this).children("input")

                        var input = inputHelp[0];
                        if (input != null && input != undefined && input != "") {
                            if (input.name != null && input.name != undefined && input.name != "") {
                                var nameHelp1ero = input.name.substring(0, 28);
                                //el 2do es el indice
                                var longName = input.name.length;
                                var separadorHelp = input.name.indexOf('].');
                                var nameHelp3ero = input.name.substring(separadorHelp, longName);
                                input.name = nameHelp1ero + indice + nameHelp3ero;
                            }
                        }

                        //PARA SELECTS
                        var selectHelp = $(this).children("select");
                        var select = selectHelp[0];
                        if (select != null && select != undefined && select != "") {
                            if (select.name != null && select.name != undefined && select.name != "") {
                                var nameHelp1ero = select.name.substring(0, 28);
                                //el 2do es el indice
                                var longName = select.name.length;
                                var separadorHelp = select.name.indexOf('].');
                                var nameHelp3ero = select.name.substring(separadorHelp, longName);
                                select.name = nameHelp1ero + indice + nameHelp3ero;
                            }
                        }
                        ////PARA TEXTAREA
                        //var textareaHelp = $(this).children("textarea");
                        //var textarea = textareaHelp[0];
                        //if (textarea != null && textarea != undefined && textarea != "") {
                        //    if (textarea.id != null && textarea.id != undefined && textarea.id != "") {
                        //        var idHelp = textarea.id.substring(0, 2);
                        //        textarea.id = idHelp + indice;
                        //    }
                        //    if (textarea.name != null && textarea.name != undefined && textarea.name != "") {
                        //        var nameHelp1ero = textarea.name.substring(0, 19);
                        //        //el 2do es el indice
                        //        var longName = textarea.name.length;
                        //        var separadorHelp = textarea.name.indexOf('].');
                        //        var nameHelp3ero = textarea.name.substring(separadorHelp, longName);
                        //        textarea.name = nameHelp1ero + indice + nameHelp3ero;
                        //    }
                        //}
                    })

                    indice = Number(indice) + Number(1);
                });
                $("#BtnCalcular").click();
            });
        });

        $("#btnCancelar").click(function () {
            $("#myModal").modal('hide');
            $('body').removeClass('modal-open');
            $('.modal-backdrop').remove();
            //window.location.href = '@Url.Action("Index", "Home")';
            GeoSIT.SeleccionPersonas = null;
        });

        $("#BtnGrabarNuevo").click(function () {
            if (validarValuacion()) {
                grabarValuacion();
            }
        });

        function validarValuacion() {
            var aniovacio = false;
            $(".anio").each(function () {
                if ($(this).val() == "") {
                    aniovacio = true;
                }
            });
            if (aniovacio) {
                $('#TituloInfo').html("Información - Edición de Valuación");
                $('#DescripcionInfo').html("Debe ingresar año para todas las mejoras");

                $("#MensajeInfo").removeClass('alert-success');
                $("#MensajeInfo").addClass('alert-danger');
                $("#ModalInfo").modal('show');
                return false;
            }
            return true;
        }

        function grabarValuacion() {
            var msj = "Está a punto de GRABAR la edición actual de la parcela<br>¿Está seguro de continuar?";
            $('#TituloAdvertencia').html("Advertencia - Grabar")
            $('#DescripcionAdvertencia').html(msj)
            $('#TipoAdvertencia').val('Grabar')
            $("#btnAdvertenciaOK").click(function () {

                if ($('#TipoAdvertencia').val() == 'Grabar') {
                    if (GeoSIT.InterfaseRentasHabilitada !== 0 && GeoSIT.SeleccionPersonas.accepted !== true) {
                        GeoSIT.SeleccionPersonas.pendientes = $.grep(responsablesFiscales, function(elem) {
                            return !(elem.CodSistemaTributario);
                        });
                        if (GeoSIT.SeleccionPersonas.pendientes.length > 0) {                            
                            GeoSIT.SeleccionPersonas.mappings = [];
                            completarDatosInterfaseRentas();
                            showLoading();
                            return;
                        }
                    }
                    $("#form").submit();
                }
            });
            $('#ModalAdvertencia').modal('show')
        }

        /* INTERFASE RENTAS */
        function completarDatosInterfaseRentas() {
            var responsableFiscal = GeoSIT.SeleccionPersonas.pendientes.shift();
            if (responsableFiscal != null) {
                responsableFiscal.Operacion = 1;
                responsableFiscal.TipoPersonaList = [];                
                responsableFiscal.SavedPersonaId = responsableFiscal.PersonaId;
                buscarPersonasInterfaseRentas(responsableFiscal.NombreCompleto, 0, "").done(function (personas) {
                    var callNext = true;
                    if (personas.length == 0) {
                        GeoSIT.SeleccionPersonas.mappings.push({
                            ResponsableFiscal: responsableFiscal,
                            NotFound: true
                        });
                    } else if (personas.length == 1) {                        
                        responsableFiscal.CodSistemaTributario = personas[0].Codigo;                        
                        actualizarResponsableFiscal(responsableFiscal);
                        callNext = false;
                    } else {
                        GeoSIT.SeleccionPersonas.mappings.push({
                            ResponsableFiscal: responsableFiscal,
                            Personas: personas
                        });
                    }
                    if (callNext) {
                        completarDatosInterfaseRentas();
                    }
                });
            } else {
                if (GeoSIT.SeleccionPersonas.mappings.length == 0) {
                    $("#form").submit();
                } else {
                    $.ajax({
                        url: BASE_URL + "InterfaseRentas/SeleccionarPersonas",
                        type: 'POST',
                        dataType: 'html',
                        contentType: 'application/json',
                        data: JSON.stringify(GeoSIT.SeleccionPersonas.mappings),
                        success: function (result) {
                            $("#valuacion-externo-container").html(result);
                        },
                        error: function (jqXHR, textStatus, errorThrown) {
                            console.log(textStatus, errorThrown);
                        }
                    });
                }
            }
        }

        function buscarPersonasInterfaseRentas(nombre, doc, cuit) {
            return $.ajax({
                url: BASE_URL + "InterfaseRentas/BuscarPersonas",
                type: 'POST',
                dataType: 'json',
                data: { nombre: nombre, doc: doc, cuit: cuit }
            });
        }

        function actualizarResponsableFiscal(responsableFiscal, externalCall) {            
            return $.ajax({
                url: BASE_URL + "Valuacion/AsignarResponsableFiscal",
                type: 'POST',
                dataType: 'json',
                contentType: 'application/json',
                data: JSON.stringify(responsableFiscal),
                success: function () {
                    for (var i = 0; i < responsablesFiscales.length; i++) {
                        if (responsablesFiscales[i].PersonaId == responsableFiscal.PersonaId) {
                            responsablesFiscales[i].CodSistemaTributario = responsableFiscal.CodSistemaTributario;
                            break;
                        }
                    }
                    if (!externalCall) {
                        completarDatosInterfaseRentas();
                    }
                }
            });
        }

        $("#form").ajaxForm({
            beforeSubmit: function (arr, $form, options) {
                showLoading();
                $("#myModal").modal('hide');
                return true; //it will continue your submission.
            },
            success: function (data) {
                //levantar modal
                $("#contenido").empty();
                $("#contenido").html(data);

            },
            error: function () {
                alert("error");
            }
        });

        $("#form").submit(function (evt) {
            /*evita el doble submit*/
            $('#myModal').modal('hide');
            evt.preventDefault();
            evt.stopImmediatePropagation();
            return false;
        });

        $("[id!='Grilla_VP']table.table.table-striped.table-bordered.table-responsive.hover.dataTable.no-footer").css("width", "100%");
        $("#Grilla_VP_wrapper .dataTables_scroll .dataTables_scrollHead .dataTables_scrollHeadInner").css("width", "100%");
        hideLoading();
    });
    $("#VigenciaDesde").on("dp.change", function (e) {
        $('#VigenciaHasta').data("DateTimePicker").minDate(e.date);
    });
    $("#VigenciaHasta").on("dp.change", function (e) {
        $('#VigenciaDesde').data("DateTimePicker").maxDate(e.date);
    });

    $(document).on('click', 'input[type=checkbox]', function () {

        if ($(this).prop("checked")) {

            $(this).parent().parent().addClass('selected')
        } else {
            $(this).parent().parent().removeClass('selected')
        }
    });

    $(".sorting_asc").removeClass("sorting_asc");
    function EditarFechaDesde_VI(Id) {

        $('#TituloFechas').html("Modificar Fecha de Vigencia Desde");
        $('#div_Descricpion_Fechas').html("Vig. Desde :");
        $('#Id_Fecha_Editar').val(Id);
        $('#FechaEdicion input').val(moment($("#FechaVigDesde_VI_" + Id).val(), 'DD/MM/YYYY hh:mm:ss a').format('DD/MM/YYYY'));
        $('#TipoFecha').val("Desde_VI");
        $('#ModalFechas').modal('show')
    }

    function EditarFechaHasta_VI(Id) {
        //$("#VI_Vig_Hasta_" + Id).html('31/05/2016 &ensp;&ensp; <img onclick="javascript: EditarFechaHasta_VI(' + Id + ');"title="Editar Vigencia Hasta" src="~/Content/images/Seguridad/icons/blue/16/editar.png" style="cursor:pointer;">');
        $('#TituloFechas').html("Modificar Fecha de Vigencia Hasta");
        $('#div_Descricpion_Fechas').html("Vig. Hasta :");
        $('#Id_Fecha_Editar').val(Id);
        $('#FechaEdicion input').val(moment($("#FechaVigHasta_VI_" + Id).val(), 'DD/MM/YYYY hh:mm:ss a').format('DD/MM/YYYY'));
        $('#TipoFecha').val("Hasta_VI");
        $('#ModalFechas').modal('show')
    }

    function EditarFechaDesde_VP(Id) {
        //$("#VP_Vig_Desde_" + Id).html('01/01/2016 &ensp;&ensp; <img onclick="javascript: EditarFechaDesde_VP(' + Id + ');"title="Editar Vigencia Desde" src="~/Content/images/Seguridad/icons/blue/16/editar.png" style="cursor:pointer;">');
        $('#TituloFechas').html("Modificar Fecha de Vigencia Desde");
        $('#div_Descricpion_Fechas').html("Vig. Desde :");
        $('#Id_Fecha_Editar').val(Id);
        $('#FechaEdicion input').val(moment($("#FechaVigDesde_VP_" + Id).val(), 'DD/MM/YYYY hh:mm:ss a').format('DD/MM/YYYY'));
        $('#TipoFecha').val("Desde_VP");
        $('#ModalFechas').modal('show')
    }

    function EditarFechaHasta_VP(Id) {
        //$("#VP_Vig_Hasta_" + Id).html('31/05/2016 &ensp;&ensp; <img onclick="javascript: EditarFechaHasta_VP(' + Id + ');"title="Editar Vigencia Hasta" src="~/Content/images/Seguridad/icons/blue/16/editar.png" style="cursor:pointer;">');
        $('#TituloFechas').html("Modificar Fecha de Vigencia Hasta");
        $('#div_Descricpion_Fechas').html("Vig. Hasta :");
        $('#Id_Fecha_Editar').val(Id);
        $('#FechaEdicion input').val(moment($("#FechaVigHasta_VP_" + Id).val(), 'DD/MM/YYYY hh:mm:ss a').format('DD/MM/YYYY'));
        $('#TipoFecha').val("Hasta_VP");
        $('#ModalFechas').modal('show')
    }
    function getParameterByName(name) {
        name = name.replace('/[\[]/', '\\[').replace('/[\]]/', '\\]');
        var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
            results = regex.exec(location.search);
        return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
    }
    function MostrarMensaje() {

        var MensajeEntrada = getParameterByName('Mensaje');
        if (MensajeEntrada != null && MensajeEntrada != '') {
            if (MensajeEntrada == "OK") {
                $('#TituloInfo').html("Información - Edición de Valuación")
                $('#DescripcionInfo').html("Los datos han sido guardados satisfactoriamente.")
                $('#TipoInformacion').val('GrabacionOK')
                $("#MensajeInfo").removeClass('alert-danger');
                $("#MensajeInfo").addClass('alert-success');

                $("#ModalInfo").modal('show');
            }

        }
    }

    function ajustarColumnasVP(){
        $("#Grilla_VP").dataTable().api().columns.adjust();
        $("#Grilla_VP").closest(".dataTables_scroll").find(" .dataTables_scrollHead .dataTables_scrollHeadInner").css('width', '100%');
        $("#Grilla_VP").closest(".dataTables_scroll").find(" .dataTables_scrollHead .dataTables_scrollHeadInner .table").css('width', '100%');
    }


    //# sourceURL=valuacion.js
</script>